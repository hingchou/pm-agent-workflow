# ============================================================
# Gherkin 测试模板
# 运行方法: pytest --gherkin tests/
# ============================================================

Feature: [功能名称]
  作为 [角色]
  我想要 [做什么]
  以便 [达成什么目标]

  Background: 测试环境准备
    Given 系统已启动
    And 数据库已清空
    And 测试用户 "test_user_001" 已创建

  # ============================================================
  # Happy Path（正常流程）
  # ============================================================

  Scenario: 正常流程 - 用户成功注册
    Given 系统处于正常运行状态
    When 用户提交注册请求，数据如下：
      | username | email              | password     |
      | john_doe | john@example.com   | SecurePass1! |
    Then 系统应返回状态码 201
    And 响应 JSON 应包含字段 "user_id"
    And 数据库应存在 1 条 username 为 "john_doe" 的记录

  Scenario: 正常流程 - 用户成功登录
    Given 用户 "john_doe" 已注册且已激活
    When 用户使用正确的用户名和密码登录
    Then 系统应返回状态码 200
    And 响应应包含 JWT Token

  # ============================================================
  # Edge Cases（边界情况）
  # ============================================================

  Scenario: 边界情况 - 用户名长度为最小值（3 字符）
    When 用户提交注册请求，username 为 "abc"
    Then 系统应返回状态码 201
    And 注册应成功

  Scenario: 边界情况 - 用户名长度为最大值（32 字符）
    When 用户提交注册请求，username 为 32 个字符的合法字符串
    Then 系统应返回状态码 201
    And 注册应成功

  # ============================================================
  # Error Cases（异常流程）
  # ============================================================

  Scenario: 异常流程 - 用户名使用保留词
    When 用户提交注册请求，username 为 "admin"
    Then 系统应返回状态码 400
    And 错误码应为 "VAL_001"
    And 错误信息应包含 "用户名不能使用保留词"

  Scenario: 异常流程 - 邮箱格式错误
    When 用户提交注册请求，email 为 "not-an-email"
    Then 系统应返回状态码 400
    And 错误码应为 "VAL_001"

  Scenario: 异常流程 - 用户名已存在
    Given 用户 "john_doe" 已注册
    When 另一个用户尝试使用相同用户名注册
    Then 系统应返回状态码 409
    And 错误信息应包含 "用户名已被占用"

  # ============================================================
  # Timeout & Network（超时和网络异常）
  # ============================================================

  Scenario: 网络异常 - 外部 API 超时
    Given 外部邮件服务响应时间 > 5 秒
    When 用户提交注册请求
    Then 系统应在 5 秒后返回响应
    And 响应状态应为 "timeout"
    And 系统应触发重试机制（最多 3 次）

  Scenario: 网络异常 - 数据库连接失败
    Given 数据库不可用
    When 用户提交注册请求
    Then 系统应返回状态码 503
    And 错误码应为 "SYS_999"

  Scenario: 并发冲突 - 同时注册相同用户名
    Given 两个用户同时提交注册请求，username 均为 "john_doe"
    When 两个请求几乎同时到达服务器（时间差 < 10ms）
    Then 只有 1 个请求应成功（返回 201）
    And 另一个请求应失败（返回 409）

  # ============================================================
  # Performance（性能要求）
  # ============================================================

  Scenario: 性能要求 - 注册接口响应时间
    When 用户提交注册请求
    Then 系统应在 200ms 内返回响应（P95）

  Scenario: 性能要求 - 高并发场景
    Given 系统同时接收 100 个注册请求
    When 所有请求在 1 秒内发出
    Then 至少 95% 的请求应成功处理

  # ============================================================
  # Security（安全要求）
  # ============================================================

  Scenario: 安全要求 - 密码不能明文存储
    Given 用户 "john_doe" 已注册，密码为 "SecurePass1!"
    When 查询数据库中该用户的记录
    Then password_hash 字段应为 Bcrypt 加密后的值

  Scenario: 安全要求 - 日志不能包含 PII
    Given 用户提交注册请求，邮箱为 "john@example.com"
    When 系统记录日志
    Then 日志中不应包含完整邮箱地址
    And 邮箱应被脱敏为 "j***@example.com"

  Scenario: 安全要求 - SQL 注入防护
    When 用户提交注册请求，username 为 "admin'; DROP TABLE users;--"
    Then 系统应返回状态码 400
    And 数据库中的 users 表应完好无损
