# é¡¹ç›®å®ªæ³• (Project Constitution)

> **åˆ›å»ºæ—¶é—´:** [è‡ªåŠ¨å¡«å……]  
> **é¡¹ç›®åç§°:** [é¡¹ç›®åç§°]  
> **è´Ÿè´£äºº:** [PM åå­—]

---

## ğŸ”§ Tech Stack

### åç«¯
- **è¯­è¨€:** Python 3.11+
- **æ¡†æ¶:** FastAPI 0.104+
- **æ•°æ®åº“:** PostgreSQL 15+ / Redis 7+
- **ORM:** SQLAlchemy 2.0+ (å¼‚æ­¥æ¨¡å¼)

### å‰ç«¯ï¼ˆå¦‚é€‚ç”¨ï¼‰
- **è¯­è¨€:** TypeScript 5+
- **æ¡†æ¶:** Next.js 14+ (App Router)
- **çŠ¶æ€ç®¡ç†:** Zustand / TanStack Query
- **UI åº“:** shadcn/ui + Tailwind CSS

### åŸºç¡€è®¾æ–½
- **å®¹å™¨åŒ–:** Docker + Docker Compose
- **CI/CD:** GitHub Actions
- **ç›‘æ§:** Sentry (é”™è¯¯è¿½è¸ª) + Prometheus (æŒ‡æ ‡)

---

## ğŸš« NEVER Rulesï¼ˆçº¢çº¿è§„åˆ™ï¼‰

### å®‰å…¨ç±»
1. ğŸš« **ä¸¥ç¦åœ¨æ—¥å¿—ä¸­æ‰“å° PII**ï¼ˆå§“åã€æ‰‹æœºå·ã€é‚®ç®±ã€èº«ä»½è¯å·ï¼‰
2. ğŸš« **ä¸¥ç¦ç¡¬ç¼–ç å¯†é’¥**ï¼ˆAPI Keyã€æ•°æ®åº“å¯†ç å¿…é¡»ç”¨ç¯å¢ƒå˜é‡ï¼‰
3. ğŸš« **ä¸¥ç¦æœªéªŒè¯çš„ç”¨æˆ·è¾“å…¥**ï¼ˆæ‰€æœ‰å¤–éƒ¨è¾“å…¥å¿…é¡»ç»è¿‡ Pydantic éªŒè¯ï¼‰
4. ğŸš« **ä¸¥ç¦ SQL å­—ç¬¦ä¸²æ‹¼æ¥**ï¼ˆå¿…é¡»ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æˆ– ORMï¼‰

### ä»£ç è´¨é‡ç±»
5. ğŸš« **ä¸¥ç¦ä½¿ç”¨ `any` ç±»å‹**ï¼ˆTypeScriptï¼‰æˆ–æ— ç±»å‹æç¤ºï¼ˆPythonï¼‰
6. ğŸš« **ä¸¥ç¦å¼•å…¥ <2 æ˜Ÿçš„ GitHub åº“**ï¼ˆæœªç»å®¡è®¡çš„ä¾èµ–ï¼‰
7. ğŸš« **ä¸¥ç¦æ— è¶…æ—¶çš„å¤–éƒ¨è°ƒç”¨**ï¼ˆHTTP è¯·æ±‚å¿…é¡»è®¾ç½® `timeout`ï¼‰
8. ğŸš« **ä¸¥ç¦æ­»å¾ªç¯**ï¼ˆ`while True` å¿…é¡»æœ‰æ˜ç¡®çš„ `break` æ¡ä»¶ï¼‰

### æˆæœ¬æ§åˆ¶ç±»
9. ğŸš« **ä¸¥ç¦æ— é™åˆ¶çš„ LLM è°ƒç”¨**ï¼ˆå¿…é¡»è®¾ç½® `max_tokens` å’Œé‡è¯•ä¸Šé™ï¼‰
10. ğŸš« **ä¸¥ç¦å•æ¬¡è¯·æ±‚æˆæœ¬ >$0.5**ï¼ˆè¶…è¿‡éœ€ PM å®¡æ‰¹ï¼‰

---

## ğŸ“ Git æäº¤è§„èŒƒ

ä½¿ç”¨ Conventional Commits æ ¼å¼ï¼š

Copy
():

```
Type ç±»å‹
feat: æ–°åŠŸèƒ½
fix: Bug ä¿®å¤
audit: å®¡è®¡æŠ¥å‘Šæ›´æ–°
spec: è§„æ ¼æ–‡æ¡£ä¿®æ”¹
refactor: é‡æ„ï¼ˆä¸æ”¹å˜åŠŸèƒ½ï¼‰
test: æµ‹è¯•ç”¨ä¾‹æ›´æ–°
docs: æ–‡æ¡£æ›´æ–°
chore: æ„å»ºå·¥å…·æˆ–ä¾èµ–æ›´æ–°
ç¤ºä¾‹
feat(auth): æ·»åŠ  OAuth2 ç™»å½•æ”¯æŒ

- å®ç° Google/GitHub ç¬¬ä¸‰æ–¹ç™»å½•
- æ·»åŠ  JWT Token åˆ·æ–°æœºåˆ¶
- é€šè¿‡ @nova-judge å®¡è®¡ï¼ˆè¯„åˆ† 92/100ï¼‰

Closes #123
ğŸ” ä»£ç å®¡æŸ¥æµç¨‹
Pull Request å¿…å¤‡æ¡ä»¶
âœ… æ‰€æœ‰ Gherkin æµ‹è¯•é€šè¿‡ï¼ˆpytest --gherkinï¼‰
âœ… é€šè¿‡ mypy/eslint é™æ€æ£€æŸ¥
âœ… @nova-judge å®¡è®¡è¯„åˆ† â‰¥ 80
âœ… ä»£ç è¦†ç›–ç‡ â‰¥ 80%ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
âœ… è‡³å°‘ 1 äºº Code Review é€šè¿‡
åˆå¹¶æ¡ä»¶
å¸¸è§„ PR: è¯„åˆ† â‰¥ 80 + 1 äººæ‰¹å‡†
å…³é”®åŠŸèƒ½ PR: è¯„åˆ† â‰¥ 90 + 2 äººæ‰¹å‡† + PM ç¡®è®¤
å®‰å…¨ç›¸å…³ PR: è¯„åˆ† = 100 + å®‰å…¨ä¸“å®¶æ‰¹å‡†
ğŸ“¦ ä¾èµ–ç®¡ç†è§„åˆ™
æ–°å¢ä¾èµ–å®¡æ‰¹æµç¨‹
æäº¤ä¾èµ–ç”³è¯·ï¼ˆè¯´æ˜ç”¨é€”ï¼‰
æ£€æŸ¥ GitHub Starsï¼ˆå¿…é¡» â‰¥ 100ï¼‰
æ£€æŸ¥æœ€åæ›´æ–°æ—¶é—´ï¼ˆ6 ä¸ªæœˆå†…æœ‰æ›´æ–°ï¼‰
è¿è¡Œ @nova-judge å®¡è®¡ä¾èµ–å®‰å…¨æ€§
PM æ‰¹å‡†åæ–¹å¯æ·»åŠ åˆ° requirements.txt / package.json
ç¦æ­¢ä½¿ç”¨çš„åº“
âŒ eval() / exec()ï¼ˆPythonï¼‰
âŒ dangerouslySetInnerHTMLï¼ˆReactï¼‰
âŒ ä»»ä½•æ ‡è®°ä¸º "deprecated" çš„åº“
ğŸ¯ æ€§èƒ½åŸºå‡†
API å“åº”æ—¶é—´
P50: < 200ms
P95: < 500ms
P99: < 1000ms
æ•°æ®åº“æŸ¥è¯¢
å•æ¬¡æŸ¥è¯¢: < 50ms
å¤æ‚è”è¡¨æŸ¥è¯¢: < 200ms
ç¦æ­¢ N+1 æŸ¥è¯¢ï¼ˆå¿…é¡»ä½¿ç”¨ joinedload æˆ– DataLoaderï¼‰
LLM è°ƒç”¨
å•æ¬¡æˆæœ¬: < $0.05
è¶…æ—¶æ—¶é—´: 30 ç§’
å¤±è´¥é‡è¯•: æœ€å¤š 3 æ¬¡ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
ğŸ“Š ç›‘æ§ä¸å‘Šè­¦
å¿…é¡»ç›‘æ§çš„æŒ‡æ ‡
é”™è¯¯ç‡: > 1% è§¦å‘å‘Šè­¦
å“åº”æ—¶é—´: P95 > 1s è§¦å‘å‘Šè­¦
LLM æˆæœ¬: æ—¥æ¶ˆè€— > $100 è§¦å‘å‘Šè­¦
æ•°æ®åº“è¿æ¥æ•°: > 80% è§¦å‘å‘Šè­¦
Sentry é”™è¯¯åˆ†çº§
Critical: å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¦‚ç™»å½•ã€æ”¯ä»˜ï¼‰
High: å½±å“éƒ¨åˆ†ç”¨æˆ·
Medium: ä¸å½±å“åŠŸèƒ½ä½†éœ€ä¿®å¤
Low: ä¼˜åŒ–ç±»é—®é¢˜
ğŸ”„ ç‰ˆæœ¬å‘å¸ƒè§„åˆ™
ç‰ˆæœ¬å·æ ¼å¼
MAJOR.MINOR.PATCH

MAJOR: ä¸å…¼å®¹çš„ API å˜æ›´
MINOR: æ–°å¢åŠŸèƒ½ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
PATCH: Bug ä¿®å¤
å‘å¸ƒå‰æ£€æŸ¥æ¸…å•
 æ‰€æœ‰æµ‹è¯•é€šè¿‡
 å®¡è®¡è¯„åˆ† â‰¥ 85
 æ•°æ®åº“è¿ç§»è„šæœ¬å·²æµ‹è¯•
 Changelog å·²æ›´æ–°
 å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡
ğŸ“š æ–‡æ¡£è¦æ±‚
å¿…é¡»ç»´æŠ¤çš„æ–‡æ¡£
API æ–‡æ¡£: ä½¿ç”¨ OpenAPI / FastAPI è‡ªåŠ¨ç”Ÿæˆ
æ•°æ®å¥‘çº¦: æ‰€æœ‰ Pydantic æ¨¡å‹å¿…é¡»æœ‰å®Œæ•´çš„ description
æ¶æ„å†³ç­–è®°å½• (ADR): é‡å¤§æŠ€æœ¯å†³ç­–å¿…é¡»è®°å½•
Runbook: å¸¸è§æ•…éšœæ’æŸ¥æ‰‹å†Œ
æ³¨é‡Šè§„èŒƒ
å‡½æ•°: å¿…é¡»æœ‰ Docstringï¼ˆGoogle é£æ ¼ï¼‰
å¤æ‚é€»è¾‘: æ·»åŠ è¡Œå†…æ³¨é‡Šè§£é‡Š"ä¸ºä»€ä¹ˆ"ï¼ˆä¸æ˜¯"åšä»€ä¹ˆ"ï¼‰
Magic Number: å¿…é¡»ç”¨å¸¸é‡æ›¿ä»£å¹¶æ³¨é‡Š
ğŸ›¡ï¸ å®‰å…¨åŸºçº¿
è®¤è¯ä¸æˆæƒ
ä½¿ç”¨ JWT Tokenï¼ˆ15 åˆ†é’Ÿè¿‡æœŸ + Refresh Tokenï¼‰
API å¿…é¡»æœ‰ Rate Limitingï¼ˆ100 req/min/userï¼‰
æ•æ„Ÿæ“ä½œå¿…é¡»äºŒæ¬¡éªŒè¯ï¼ˆå¦‚åˆ é™¤æ•°æ®ï¼‰
æ•°æ®ä¿æŠ¤
PII æ•°æ®å¿…é¡»åŠ å¯†å­˜å‚¨ï¼ˆAES-256ï¼‰
å¯†ç å¿…é¡»ä½¿ç”¨ bcryptï¼ˆcost factor â‰¥ 12ï¼‰
æ—¥å¿—è„±æ•ï¼ˆæ‰‹æœºå·æ˜¾ç¤ºä¸º 138****5678ï¼‰
ä¾èµ–å®‰å…¨
æ¯å‘¨è¿è¡Œ pip-audit / npm audit
å‘ç°é«˜å±æ¼æ´å¿…é¡» 48 å°æ—¶å†…ä¿®å¤
ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®
å¿…è£…å·¥å…·
Copy# Python
pip install black isort mypy pytest pytest-bdd

# Pre-commit hooks
pre-commit install
IDE é…ç½®
VSCode: ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„ .vscode/settings.json
PyCharm: å¯ç”¨ Pydantic æ’ä»¶
å¼ºåˆ¶æ ¼å¼åŒ–: ä¿å­˜æ—¶è‡ªåŠ¨è¿è¡Œ Black / Prettier
ğŸ“ ç´§æ€¥è”ç³»äºº
PM: [ä½ çš„åå­—] - [è”ç³»æ–¹å¼]
Tech Lead: [æŠ€æœ¯è´Ÿè´£äºº] - [è”ç³»æ–¹å¼]
On-call å·¥ç¨‹å¸ˆ: [è½®å€¼è¡¨é“¾æ¥]
ğŸ“ å›¢é˜ŸåŸ¹è®­è¦æ±‚
æ–°æˆå‘˜ Onboarding
é˜…è¯»æœ¬æ–‡æ¡£å¹¶ç­¾å­—ç¡®è®¤
å®Œæˆä¸€æ¬¡å®Œæ•´çš„ Spec â†’ Code â†’ Audit æµç¨‹
é€šè¿‡ Code Review è€ƒæ ¸ï¼ˆæäº¤ 3 ä¸ª PR ä¸”å…¨éƒ¨é€šè¿‡ï¼‰
æŒç»­å­¦ä¹ 
æ¯æœˆ 1 æ¬¡æŠ€æœ¯åˆ†äº«ä¼š
æ¯å­£åº¦å›é¡¾å¹¶æ›´æ–°æœ¬æ–‡æ¡£
Bug å¯¼è‡´çš„äº‹æ•…å¿…é¡»å†™ Post-Mortem
æœ€åæ›´æ–°: [è‡ªåŠ¨å¡«å……æ—¥æœŸ]
ç‰ˆæœ¬: v1.0.0


---

### **3.3 æ¨¡æ¿æ–‡ä»¶ 2ï¼š`templates/data_contract.py.template`**

**æ–‡ä»¶è·¯å¾„ï¼š`templates/data_contract.py.template`**

```python
"""
æ•°æ®å¥‘çº¦æ¨¡æ¿
ç”¨é€”ï¼šå®šä¹‰ç³»ç»Ÿä¸­æ‰€æœ‰æ•°æ®ç»“æ„çš„æ ‡å‡†æ ¼å¼

ä½¿ç”¨æ–¹æ³•ï¼š
1. å¤åˆ¶æœ¬æ–‡ä»¶åˆ° schemas/ ç›®å½•
2. æ ¹æ®å®é™…ä¸šåŠ¡ä¿®æ”¹ç±»åå’Œå­—æ®µ
3. ç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æœ‰ description
4. æ·»åŠ è‡³å°‘ 3 ä¸ª validator
"""

from pydantic import BaseModel, Field, field_validator, model_validator
from typing import Literal, Annotated
from datetime import datetime
from enum import Enum


# ============================================================
# æšä¸¾ç±»å‹å®šä¹‰ï¼ˆæ¨èä½¿ç”¨ Enum è€Œé Literalï¼‰
# ============================================================

class UserStatus(str, Enum):
    """ç”¨æˆ·çŠ¶æ€æšä¸¾"""
    PENDING = "pending"        # å¾…æ¿€æ´»
    ACTIVE = "active"          # å·²æ¿€æ´»
    SUSPENDED = "suspended"    # å·²æš‚åœ
    BANNED = "banned"          # å·²å°ç¦


class ErrorCode(str, Enum):
    """ç³»ç»Ÿé”™è¯¯ç """
    VALIDATION_ERROR = "VAL_001"
    AUTH_ERROR = "AUTH_002"
    TIMEOUT_ERROR = "NET_003"
    UNKNOWN_ERROR = "SYS_999"


# ============================================================
# è¯·æ±‚æ¨¡å‹ï¼ˆRequest Modelsï¼‰
# ============================================================

class UserCreateRequest(BaseModel):
    """
    ç”¨æˆ·åˆ›å»ºè¯·æ±‚
    
    ä½¿ç”¨åœºæ™¯ï¼šç”¨æˆ·æ³¨å†Œæ¥å£
    å®‰å…¨è¦æ±‚ï¼šå¯†ç å¿…é¡»ç»è¿‡å‰ç«¯åŠ å¯†ä¼ è¾“
    """
    
    username: Annotated[str, Field(
        min_length=3,
        max_length=32,
        pattern="^[a-zA-Z0-9_]+$",
        description="ç”¨æˆ·åï¼Œä»…å…è®¸å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿"
    )]
    
    email: Annotated[str, Field(
        pattern=r"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$",
        description="é‚®ç®±åœ°å€ï¼Œå¿…é¡»ç¬¦åˆæ ‡å‡†æ ¼å¼"
    )]
    
    password_hash: Annotated[str, Field(
        min_length=60,
        max_length=60,
        description="Bcrypt åŠ å¯†åçš„å¯†ç ï¼ˆå‰ç«¯å·²åŠ å¯†ï¼‰"
    )]
    
    @field_validator("username")
    @classmethod
    def validate_username(cls, v: str) -> str:
        """æ ¡éªŒç”¨æˆ·åä¸èƒ½æ˜¯ä¿ç•™è¯"""
        reserved_words = ["admin", "root", "system", "test"]
        if v.lower() in reserved_words:
            raise ValueError(f"ç”¨æˆ·åä¸èƒ½ä½¿ç”¨ä¿ç•™è¯: {', '.join(reserved_words)}")
        return v
    
    @field_validator("email")
    @classmethod
    def validate_email_domain(cls, v: str) -> str:
        """æ ¡éªŒé‚®ç®±åŸŸåä¸åœ¨é»‘åå•ä¸­"""
        blocked_domains = ["tempmail.com", "guerrillamail.com"]
        domain = v.split("@")[1]
        if domain in blocked_domains:
            raise ValueError(f"ä¸æ”¯æŒçš„é‚®ç®±åŸŸå: {domain}")
        return v.lower()  # ç»Ÿä¸€è½¬å°å†™


class UserActionRequest(BaseModel):
    """
    ç”¨æˆ·åŠ¨ä½œè®°å½•è¯·æ±‚
    
    ä½¿ç”¨åœºæ™¯ï¼šç”¨æˆ·è¡Œä¸ºåŸ‹ç‚¹
    æ€§èƒ½è¦æ±‚ï¼šé«˜é¢‘è°ƒç”¨ï¼Œéœ€å¼‚æ­¥å¤„ç†
    """
    
    user_id: Annotated[str, Field(
        pattern="^usr_[a-zA-Z0-9]{16}$",
        description="ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ ¼å¼: usr_xxxxxxxxxxxxxxxx"
    )]
    
    action_type: Literal["click", "scroll", "submit", "navigate"] = Field(
        description="åŠ¨ä½œç±»å‹ï¼Œé™å®šæšä¸¾å€¼"
    )
    
    timestamp: datetime = Field(
        description="åŠ¨ä½œå‘ç”Ÿçš„ UTC æ—¶é—´æˆ³",
        examples=["2026-02-09T08:30:00Z"]
    )
    
    metadata: dict = Field(
        default_factory=dict,
        description="é¢å¤–çš„å…ƒæ•°æ®ï¼ˆå¦‚é¡µé¢ URLã€å…ƒç´  IDï¼‰"
    )
    
    @field_validator("timestamp")
    @classmethod
    def validate_timestamp(cls, v: datetime) -> datetime:
        """æ ¡éªŒæ—¶é—´æˆ³ä¸èƒ½æ˜¯æœªæ¥æ—¶é—´"""
        if v > datetime.utcnow():
            raise ValueError("æ—¶é—´æˆ³ä¸èƒ½æ˜¯æœªæ¥æ—¶é—´")
        return v
    
    @model_validator(mode="after")
    def validate_metadata_size(self) -> "UserActionRequest":
        """æ ¡éªŒ metadata å¤§å°ä¸è¶…è¿‡ 1KB"""
        import json
        size = len(json.dumps(self.metadata))
        if size > 1024:
            raise ValueError(f"metadata å¤§å°è¶…é™: {size} bytes (æœ€å¤§ 1KB)")
        return self


# ============================================================
# å“åº”æ¨¡å‹ï¼ˆResponse Modelsï¼‰
# ============================================================

class UserResponse(BaseModel):
    """
    ç”¨æˆ·ä¿¡æ¯å“åº”
    
    æ³¨æ„ï¼šå¯†ç å­—æ®µå·²æ’é™¤ï¼Œä¸ä¼šè¿”å›ç»™å‰ç«¯
    """
    
    user_id: str = Field(description="ç”¨æˆ· ID")
    username: str = Field(description="ç”¨æˆ·å")
    email: str = Field(description="é‚®ç®±ï¼ˆå·²è„±æ•ï¼‰")
    status: UserStatus = Field(description="ç”¨æˆ·çŠ¶æ€")
    created_at: datetime = Field(description="åˆ›å»ºæ—¶é—´")
    
    @field_validator("email", mode="after")
    @classmethod
    def mask_email(cls, v: str) -> str:
        """é‚®ç®±è„±æ•å¤„ç†"""
        if "@" not in v:
            return v
        local, domain = v.split("@")
        if len(local) <= 2:
            masked_local = "*" * len(local)
        else:
            masked_local = local[0] + "*" * (len(local) - 2) + local[-1]
        return f"{masked_local}@{domain}"


class APIResponse(BaseModel):
    """
    æ ‡å‡† API å“åº”æ ¼å¼
    
    æ‰€æœ‰æ¥å£å¿…é¡»ä½¿ç”¨æ­¤æ ¼å¼è¿”å›
    """
    
    status: Literal["success", "error", "timeout"] = Field(
        description="å“åº”çŠ¶æ€"
    )
    
    data: dict | list | None = Field(
        default=None,
        description="ä¸šåŠ¡æ•°æ®ï¼ˆæˆåŠŸæ—¶è¿”å›ï¼‰"
    )
    
    error: "ErrorDetail | None" = Field(
        default=None,
        description="é”™è¯¯è¯¦æƒ…ï¼ˆå¤±è´¥æ—¶è¿”å›ï¼‰"
    )
    
    timestamp: datetime = Field(
        default_factory=datetime.utcnow,
        description="å“åº”ç”Ÿæˆæ—¶é—´"
    )
    
    @model_validator(mode="after")
    def validate_response(self) -> "APIResponse":
        """æ ¡éªŒå“åº”çš„æ•°æ®ä¸€è‡´æ€§"""
        if self.status == "success" and self.data is None:
            raise ValueError("æˆåŠŸå“åº”å¿…é¡»åŒ…å« data å­—æ®µ")
        if self.status == "error" and self.error is None:
            raise ValueError("é”™è¯¯å“åº”å¿…é¡»åŒ…å« error å­—æ®µ")
        return self


class ErrorDetail(BaseModel):
    """é”™è¯¯è¯¦æƒ…"""
    
    code: ErrorCode = Field(description="é”™è¯¯ç ")
    message: str = Field(description="é”™è¯¯æè¿°ï¼ˆç”¨æˆ·å¯è¯»ï¼‰")
    details: dict = Field(
        default_factory=dict,
        description="æŠ€æœ¯ç»†èŠ‚ï¼ˆä»…å¼€å‘ç¯å¢ƒè¿”å›ï¼‰"
    )


# ============================================================
# æ•°æ®åº“æ¨¡å‹ï¼ˆDatabase Modelsï¼‰
# ============================================================

class UserDB(BaseModel):
    """
    ç”¨æˆ·æ•°æ®åº“æ¨¡å‹
    
    æ³¨æ„ï¼šä¸ UserResponse çš„åŒºåˆ«æ˜¯åŒ…å«æ•æ„Ÿå­—æ®µ
    """
    
    user_id: str
    username: str
    email: str
    password_hash: str  # æ•æ„Ÿå­—æ®µï¼Œä¸å¯¹å¤–æš´éœ²
    status: UserStatus
    created_at: datetime
    updated_at: datetime
    
    class Config:
        """Pydantic é…ç½®"""
        from_attributes = True  # å…è®¸ä» ORM æ¨¡å‹åˆ›å»º


# ============================================================
# è¾¹ç•Œæµ‹è¯•ç”¨ä¾‹ï¼ˆç”¨äºå•å…ƒæµ‹è¯•ï¼‰
# ============================================================

def get_test_cases() -> dict:
    """
    è¿”å›è¾¹ç•Œæµ‹è¯•ç”¨ä¾‹
    
    ç”¨é€”ï¼šç¡®ä¿ Validator æ­£å¸¸å·¥ä½œ
    """
    return {
        "valid_user": {
            "username": "john_doe",
            "email": "john@example.com",
            "password_hash": "a" * 60
        },
        "invalid_username_reserved": {
            "username": "admin",
            "email": "admin@example.com",
            "password_hash": "a" * 60,
            "expected_error": "ç”¨æˆ·åä¸èƒ½ä½¿ç”¨ä¿ç•™è¯"
        },
        "invalid_email_format": {
            "username": "john",
            "email": "not-an-email",
            "password_hash": "a" * 60,
            "expected_error": "é‚®ç®±åœ°å€ï¼Œå¿…é¡»ç¬¦åˆæ ‡å‡†æ ¼å¼"
        },
        "invalid_password_length": {
            "username": "john",
            "email": "john@example.com",
            "password_hash": "short",
            "expected_error": "min_length"
        }
    }
3.4 æ¨¡æ¿æ–‡ä»¶ 3ï¼štemplates/behavior.feature.template
æ–‡ä»¶è·¯å¾„ï¼štemplates/behavior.feature.template

Copy# ============================================================
# Gherkin æµ‹è¯•æ¨¡æ¿
# ç”¨é€”ï¼šå®šä¹‰åŠŸèƒ½çš„éªŒæ”¶æ ‡å‡†ï¼ˆBDD é£æ ¼ï¼‰
#
# è¿è¡Œæ–¹æ³•ï¼š
#   pytest --gherkin tests/
# ============================================================

Feature: [åŠŸèƒ½åç§°]
  ä½œä¸º [è§’è‰²]
  æˆ‘æƒ³è¦ [åšä»€ä¹ˆ]
  ä»¥ä¾¿ [è¾¾æˆä»€ä¹ˆç›®æ ‡]

  Background: æµ‹è¯•ç¯å¢ƒå‡†å¤‡
    Given ç³»ç»Ÿå·²å¯åŠ¨
    And æ•°æ®åº“å·²æ¸…ç©º
    And æµ‹è¯•ç”¨æˆ· "test_user_001" å·²åˆ›å»º

  # ============================================================
  # Happy Pathï¼ˆæ­£å¸¸æµç¨‹ï¼‰
  # ============================================================

  Scenario: æ­£å¸¸æµç¨‹ - ç”¨æˆ·æˆåŠŸæ³¨å†Œ
    Given ç³»ç»Ÿå¤„äºæ­£å¸¸è¿è¡ŒçŠ¶æ€
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚ï¼Œæ•°æ®å¦‚ä¸‹ï¼š
      | username | email              | password     |
      | john_doe | john@example.com   | SecurePass1! |
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  201
    And å“åº” JSON åº”åŒ…å«å­—æ®µ "user_id"
    And æ•°æ®åº“åº”å­˜åœ¨ 1 æ¡ username ä¸º "john_doe" çš„è®°å½•
    And ç”¨æˆ·åº”æ”¶åˆ°æ¿€æ´»é‚®ä»¶

  Scenario: æ­£å¸¸æµç¨‹ - ç”¨æˆ·æˆåŠŸç™»å½•
    Given ç”¨æˆ· "john_doe" å·²æ³¨å†Œä¸”å·²æ¿€æ´»
    When ç”¨æˆ·ä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  200
    And å“åº”åº”åŒ…å« JWT Token
    And Token åº”åœ¨ 15 åˆ†é’Ÿåè¿‡æœŸ

  # ============================================================
  # Edge Casesï¼ˆè¾¹ç•Œæƒ…å†µï¼‰
  # ============================================================

  Scenario: è¾¹ç•Œæƒ…å†µ - ç”¨æˆ·åé•¿åº¦ä¸ºæœ€å°å€¼ï¼ˆ3 å­—ç¬¦ï¼‰
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚ï¼Œusername ä¸º "abc"
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  201
    And æ³¨å†Œåº”æˆåŠŸ

  Scenario: è¾¹ç•Œæƒ…å†µ - ç”¨æˆ·åé•¿åº¦ä¸ºæœ€å¤§å€¼ï¼ˆ32 å­—ç¬¦ï¼‰
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚ï¼Œusername ä¸º 32 ä¸ªå­—ç¬¦çš„åˆæ³•å­—ç¬¦ä¸²
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  201
    And æ³¨å†Œåº”æˆåŠŸ

  Scenario: è¾¹ç•Œæƒ…å†µ - ç”¨æˆ·ååŒ…å«ä¸‹åˆ’çº¿
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚ï¼Œusername ä¸º "john_doe_123"
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  201
    And æ³¨å†Œåº”æˆåŠŸ

  # ============================================================
  # Error Casesï¼ˆå¼‚å¸¸æµç¨‹ï¼‰
  # ============================================================

  Scenario: å¼‚å¸¸æµç¨‹ - ç”¨æˆ·åä½¿ç”¨ä¿ç•™è¯
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚ï¼Œusername ä¸º "admin"
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  400
    And é”™è¯¯ç åº”ä¸º "VAL_001"
    And é”™è¯¯ä¿¡æ¯åº”åŒ…å« "ç”¨æˆ·åä¸èƒ½ä½¿ç”¨ä¿ç•™è¯"

  Scenario: å¼‚å¸¸æµç¨‹ - é‚®ç®±æ ¼å¼é”™è¯¯
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚ï¼Œemail ä¸º "not-an-email"
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  400
    And é”™è¯¯ç åº”ä¸º "VAL_001"
    And é”™è¯¯ä¿¡æ¯åº”åŒ…å« "é‚®ç®±åœ°å€ï¼Œå¿…é¡»ç¬¦åˆæ ‡å‡†æ ¼å¼"

  Scenario: å¼‚å¸¸æµç¨‹ - ç”¨æˆ·åå·²å­˜åœ¨
    Given ç”¨æˆ· "john_doe" å·²æ³¨å†Œ
    When å¦ä¸€ä¸ªç”¨æˆ·å°è¯•ä½¿ç”¨ç›¸åŒç”¨æˆ·åæ³¨å†Œ
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  409
    And é”™è¯¯ç åº”ä¸º "VAL_001"
    And é”™è¯¯ä¿¡æ¯åº”åŒ…å« "ç”¨æˆ·åå·²è¢«å ç”¨"

  Scenario: å¼‚å¸¸æµç¨‹ - å¯†ç é•¿åº¦ä¸è¶³
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚ï¼Œpassword é•¿åº¦ < 8 å­—ç¬¦
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  400
    And é”™è¯¯ä¿¡æ¯åº”åŒ…å« "å¯†ç é•¿åº¦ä¸è¶³"

  # ============================================================
  # Timeout & Networkï¼ˆè¶…æ—¶å’Œç½‘ç»œå¼‚å¸¸ï¼‰
  # ============================================================

  Scenario: ç½‘ç»œå¼‚å¸¸ - å¤–éƒ¨ API è¶…æ—¶
    Given å¤–éƒ¨é‚®ä»¶æœåŠ¡å“åº”æ—¶é—´ > 5 ç§’
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚
    Then ç³»ç»Ÿåº”åœ¨ 5 ç§’åè¿”å›å“åº”
    And å“åº”çŠ¶æ€åº”ä¸º "timeout"
    And ç³»ç»Ÿåº”è®°å½•é”™è¯¯æ—¥å¿—
    And ç³»ç»Ÿåº”è§¦å‘é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰

  Scenario: ç½‘ç»œå¼‚å¸¸ - æ•°æ®åº“è¿æ¥å¤±è´¥
    Given æ•°æ®åº“ä¸å¯ç”¨
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  503
    And é”™è¯¯ç åº”ä¸º "SYS_999"
    And é”™è¯¯ä¿¡æ¯åº”ä¸º "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"

  Scenario: å¹¶å‘å†²çª - åŒæ—¶æ³¨å†Œç›¸åŒç”¨æˆ·å
    Given ä¸¤ä¸ªç”¨æˆ·åŒæ—¶æäº¤æ³¨å†Œè¯·æ±‚ï¼Œusername å‡ä¸º "john_doe"
    When ä¸¤ä¸ªè¯·æ±‚å‡ ä¹åŒæ—¶åˆ°è¾¾æœåŠ¡å™¨ï¼ˆæ—¶é—´å·® < 10msï¼‰
    Then åªæœ‰ 1 ä¸ªè¯·æ±‚åº”æˆåŠŸï¼ˆè¿”å› 201ï¼‰
    And å¦ä¸€ä¸ªè¯·æ±‚åº”å¤±è´¥ï¼ˆè¿”å› 409ï¼‰
    And æ•°æ®åº“åº”åªå­˜åœ¨ 1 æ¡ "john_doe" è®°å½•

  # ============================================================
  # Performanceï¼ˆæ€§èƒ½è¦æ±‚ï¼‰
  # ============================================================

  Scenario: æ€§èƒ½è¦æ±‚ - æ³¨å†Œæ¥å£å“åº”æ—¶é—´
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚
    Then ç³»ç»Ÿåº”åœ¨ 200ms å†…è¿”å›å“åº”ï¼ˆP95ï¼‰

  Scenario: æ€§èƒ½è¦æ±‚ - é«˜å¹¶å‘åœºæ™¯
    Given ç³»ç»ŸåŒæ—¶æ¥æ”¶ 100 ä¸ªæ³¨å†Œè¯·æ±‚
    When æ‰€æœ‰è¯·æ±‚åœ¨ 1 ç§’å†…å‘å‡º
    Then è‡³å°‘ 95% çš„è¯·æ±‚åº”æˆåŠŸå¤„ç†
    And å¹³å‡å“åº”æ—¶é—´åº” < 500ms

  # ============================================================
  # Securityï¼ˆå®‰å…¨è¦æ±‚ï¼‰
  # ============================================================

  Scenario: å®‰å…¨è¦æ±‚ - å¯†ç ä¸èƒ½æ˜æ–‡å­˜å‚¨
    Given ç”¨æˆ· "john_doe" å·²æ³¨å†Œï¼Œå¯†ç ä¸º "SecurePass1!"
    When æŸ¥è¯¢æ•°æ®åº“ä¸­è¯¥ç”¨æˆ·çš„è®°å½•
    Then password_hash å­—æ®µåº”ä¸º Bcrypt åŠ å¯†åçš„å€¼
    And password_hash åº”åŒ…å« "$2b$" å‰ç¼€
    And è§£å¯†åçš„å¯†ç åº”èƒ½åŒ¹é…åŸå§‹å¯†ç 

  Scenario: å®‰å…¨è¦æ±‚ - æ—¥å¿—ä¸èƒ½åŒ…å« PII
    Given ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚ï¼Œé‚®ç®±ä¸º "john@example.com"
    When ç³»ç»Ÿè®°å½•æ—¥å¿—
    Then æ—¥å¿—ä¸­ä¸åº”åŒ…å«å®Œæ•´é‚®ç®±åœ°å€
    And é‚®ç®±åº”è¢«è„±æ•ä¸º "j***@example.com"

  Scenario: å®‰å…¨è¦æ±‚ - SQL æ³¨å…¥é˜²æŠ¤
    When ç”¨æˆ·æäº¤æ³¨å†Œè¯·æ±‚ï¼Œusername ä¸º "admin'; DROP TABLE users;--"
    Then ç³»ç»Ÿåº”è¿”å›çŠ¶æ€ç  400
    And é”™è¯¯ä¿¡æ¯åº”ä¸º "ç”¨æˆ·åæ ¼å¼é”™è¯¯"
    And æ•°æ®åº“ä¸­çš„ users è¡¨åº”å®Œå¥½æ— æŸ

  # ============================================================
  # Data Cleanupï¼ˆæ•°æ®æ¸…ç†ï¼‰
  # ============================================================

  Scenario: æ•°æ®æ¸…ç† - åˆ é™¤æœªæ¿€æ´»çš„ç”¨æˆ·
    Given ç”¨æˆ· "john_doe" å·²æ³¨å†Œä½†æœªæ¿€æ´»
    And è·ç¦»æ³¨å†Œæ—¶é—´å·²è¶…è¿‡ 7 å¤©
    When ç³»ç»Ÿè¿è¡Œå®šæ—¶æ¸…ç†ä»»åŠ¡
    Then è¯¥ç”¨æˆ·è®°å½•åº”è¢«è½¯åˆ é™¤ï¼ˆstatus = "deleted"ï¼‰
    And è¯¥ç”¨æˆ·çš„é‚®ç®±åº”å¯è¢«å…¶ä»–ç”¨æˆ·é‡æ–°æ³¨å†Œ
Copy
âœ… ç¡®è®¤æ£€æŸ¥æ¸…å•
Copy# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦éƒ½å·²åˆ›å»º
ls -la templates/

# åº”æ˜¾ç¤ºä»¥ä¸‹ 3 ä¸ªæ–‡ä»¶ï¼š
# CLAUDE.md.template
# data_contract.py.template
# behavior.feature.template